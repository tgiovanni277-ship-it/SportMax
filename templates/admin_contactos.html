{% extends "base.html" %}
{% block title %}Admin - Contactos{% endblock %}

{% block content %}
<div class="container">
  <h1 class="h3 my-3">Mensajes de Contacto</h1>

  <!-- Filtros -->
  <form class="row gy-2 gx-3 align-items-end mb-3" method="GET" action="{{ url_for('admin_contactos') }}">
    <div class="col-sm-4">
      <label for="q" class="form-label">Correo contiene</label>
      <input type="text" class="form-control" id="q" name="q" placeholder="ej: @gmail.com" value="{{ q }}">
    </div>
    <div class="col-sm-3">
      <label for="from" class="form-label">Desde (YYYY-MM-DD)</label>
      <input type="date" class="form-control" id="from" name="from" value="{{ date_from }}">
    </div>
    <div class="col-sm-3">
      <label for="to" class="form-label">Hasta (YYYY-MM-DD)</label>
      <input type="date" class="form-control" id="to" name="to" value="{{ date_to }}">
    </div>
    <div class="col-sm-2">
      <label for="per_page" class="form-label">Por página</label>
      <select id="per_page" name="per_page" class="form-select">
        {% for n in [5,10,20,50] %}
          <option value="{{n}}" {% if per_page==n %}selected{% endif %}>{{n}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">Filtrar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('admin_contactos') }}">Limpiar</a>
    </div>
  </form>

  <!-- Tabla -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Correo</th>
          <th>Celular</th>  <!-- Nueva columna -->
          <th>Edad</th>  
          <th>Mensaje</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% if items and items|length > 0 %}
          {% for c in items %}
            <tr>
              <td>{{ c.id }}</td>
              <td>{{ c.nombre }}</td>
              <td><a href="mailto:{{ c.correo }}">{{ c.correo }}</a></td>
              <td>{{ c.celular if c.celular else 'N/A' }}</td>  <!-- Nueva columna -->
              <td>{{ c.edad if c.edad else 'N/A' }}</td>
              <td style="max-width: 420px;">
                {{ c.mensaje[:180] }}{% if c.mensaje|length > 180 %}…{% endif %}
              </td>
              <td>{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted">No hay mensajes con esos filtros.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  {% if pagination %}
    <nav aria-label="Paginación">
      <ul class="pagination">
        {% set args_keep = {'q': q, 'from': date_from, 'to': date_to, 'per_page': per_page} %}
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_contactos', page=1, **args_keep) }}">Primera</a>
        </li>
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_contactos', page=pagination.prev_num, **args_keep) }}">Anterior</a>
        </li>

        <li class="page-item disabled">
          <span class="page-link">
            Página {{ pagination.page }} de {{ pagination.pages if pagination.pages>0 else 1 }}
          </span>
        </li>

        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_contactos', page=pagination.next_num, **args_keep) }}">Siguiente</a>
        </li>
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_contactos', page=pagination.pages, **args_keep) }}">Última</a>
        </li>
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
